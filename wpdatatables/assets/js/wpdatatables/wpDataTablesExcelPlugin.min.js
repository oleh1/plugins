/**
 * Created by shommy on 22.5.16..
 */
!function(e){function t(t){Handsontable.plugins.BasePlugin.call(this,t),this._superClass=Handsontable.plugins.BasePlugin,this.table_id=t.rootElement.id,this.tableDrawRequests=0,this.tableDrawResponses=0,this.tableSettings={},this.$SEARCH_FIELD=e("#"+this.table_id+"_search_filter input"),this.loadLanguages()}t.prototype=Object.create(Handsontable.plugins.BasePlugin.prototype,{constructor:{writable:!0,configurable:!0,value:t}}),t.prototype.isEnabled=function(){return!!this.hot.getSettings().wpDataTablesExcelPlugin},t.prototype.enablePlugin=function(){for(var t in this.languages)numeral.language(t,this.languages[t]);var a={},o=e(this.hot.rootElement).data("described-by");o&&($descriptionElement=e("#"+o))&&(a=e.parseJSON($descriptionElement.val()),this.tableSettings=a.dataTableParams,delete a.dataTableParams);for(var l in a)this[l]=a[l];if(this.tableSettings.language="en-"+this.tableSettings.number_format,this.serverSide){for(var i=0;i<this.tableSettings.columns.length;i++)this.setCellValidator(this.tableSettings.columns[i]);this.tableSettings.minSpareRows=1,this.addContextMenuItems(),Handsontable.Search.global.setDefaultCallback(this.wdtExcelSearchCallback),this.addHook("afterChange",this.onAfterChange.bind(this)),this.addHook("init",this.onInit.bind(this)),this.addHook("afterValidate",this.onAfterValidate.bind(this))}else this.tableSettings.data=e.parseJSON(e(a.selector+"_data").val());"object"==typeof wpDtExcelTables[this.table_id]&&e.extend(!0,this.tableSettings,wpDtExcelTables[this.table_id]),this._superClass.prototype.enablePlugin.call(this)},t.prototype.initTableSettings=function(){this.hot.updateSettings(this.tableSettings)},t.prototype.disablePlugin=function(){this.tableDrawRequests=0,this.tableDrawResponses=0,this.tableSettings={},this.removeEvents(),this._superClass.prototype.disablePlugin.call(this)},t.prototype.updatePlugin=function(){this._superClass.prototype.updatePlugin.call(this)},t.prototype.destroy=function(){this._superClass.prototype.destroy.call(this)},t.prototype.initEvents=function(){var t=this.hot.rootElement;this.serverSide&&(e(t).on("click.wpExcelTable","a.wdt_link_editable",function(t){t.preventDefault(),t.ctrlKey&&window.open(e(this).attr("href"),e(this).attr("target"))}),e(t).on("click.wpExcelTable","a.wdt_email_editable",function(t){t.preventDefault(),t.ctrlKey&&(location.href=e(this).attr("href"))}))},t.prototype.initSearch=function(){var e=this.hot,t=e.getSettings();t.search&&(this.$SEARCH_FIELD.on("keyup.wpExcelTable search.wpExcelTable",function(t){e.search.query(this.value),e.render()}),t.searchDefaultValue&&this.$SEARCH_FIELD.val(t.searchDefaultValue))},t.prototype.removeEvents=function(){var t=this.hot.rootElement;e(t).off("click.wpExcelTable",".wpExcelTable a.wdt_link_editable"),e(t).off("click.wpExcelTable",".wpExcelTable a.wdt_email_editable"),this.$SEARCH_FIELD.off("keyup.wpExcelTable search.wpExcelTable")},t.prototype.getCellValidatorByName=function(e){var t=e.replace(/(?:(wdt)\.)?(.+)/,function(e,t,a){return a?(t=t||"",t+a.charAt(0).toUpperCase()+a.slice(1)+"Validator"):null});return t&&Handsontable[t]?Handsontable[t]:null},t.prototype.setCellValidator=function(e){var t=e.validator;if(t){var a=this.getCellValidatorByName(t);a&&("dropdown"==e.type||"wdt.multi-select"==e.type?(e.cell_validator=a,delete e.validator):e.validator=a)}},t.prototype.getRemoteTableData=function(){var t=this,a=this.hot,o=a.getSettings();if(o.serverSide){for(var l=o.ajax,i=o.columns,n=o.columnSorting,s=Boolean(n),r=[],h=0;h<i.length;h++){var d={data:h,name:i[h].data,searchable:i[h].search,orderable:s};r.push(d)}var u={draw:t.tableDrawRequests+1,table:"excel",columns:r,start:0,length:-1};if(s){var c=[],p=n.column,g=n.sortOrder?"asc":"desc",b={column:p,dir:g};c.push(b),u.order=c}var f={data:u,dataType:"json",success:function(e){e.draw&&e.draw>t.tableDrawResponses&&(t.tableDrawResponses=e.draw,a.loadData(e.data))},error:function(e){console.log(e)},beforeSend:function(e,a){t.tableDrawRequests++,t.toggleTableOverlay("show")},complete:function(){t.toggleTableOverlay("hide")}};e.extend(l,f),e.ajax(l)}},t.prototype.loadLanguages=function(){var t={};t.en={delimiters:{thousands:",",decimal:"."},abbreviations:{thousand:"k",million:"m",billion:"b",trillion:"t"},ordinal:function(e){var t=e%10;return 1===~~(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th"},currency:{symbol:"$"}},t["en-1"]=e.extend(!0,{},t.en),t["en-1"].delimiters.thousands=".",t["en-1"].delimiters.decimal=",",t["en-2"]=e.extend(!0,{},t.en),this.languages=t},t.prototype.queryDateCell=function(e,t,a,o){var l=e.getSettings(),i=this.$SEARCH_FIELD.val(),n=moment(o,l.dataSourceDateFormat).format(l.displayDateFormat);return Handsontable.Search.DEFAULT_QUERY_METHOD(i,n)},t.prototype.wdtExcelSearchCallback=function(e,t,a,o,l){var i=e.getCellMeta(t,a);"wdt.date"!=i.renderer||l?Handsontable.Search.DEFAULT_CALLBACK.apply(this,arguments):i.isSearchResult=e.getPlugin("WpDataTablesExcelPlugin").queryDateCell(e,t,a,o)},t.prototype.prepareDataToSaveRemote=function(t){for(var a,o,l,i,n=this.hot.getSettings(),s=n.idColumnKey,r=[],h=[],d=[],u=0;u<t.length;u++){if(a=t[u][0],o=t[u][1],l=t[u][2],i=t[u][3],l!=i)if("undefined"==typeof r[a]){var c=this.hot.getDataAtRowProp(a,s),p={};p[s]=c,p[o]=i,r[a]=p}else r[a][o]=i;if(-1==e.inArray(a,h)){var g=this.hot.getSourceDataAtRow(a);d.push(g),h.push(a)}}if(r.length>0){var b=[];for(var f in r)b.push(r[f]);r=b}return{cells:r,rows:d}};var a=function(e){e.stopImmediatePropagation(),e.preventDefault()};t.prototype.toggleTableOverlay=function(t){var o=this.hot;"show"==t?(e(o.rootElement).find("table.htCore").addClass("overlayed_elm"),o.addHook("beforeKeyDown",a)):"hide"==t&&(e(o.rootElement).find("table.htCore").removeClass("overlayed_elm"),o.removeHook("beforeKeyDown",a))},t.prototype.saveChangesRemote=function(t){var a=this.hot.getSettings(),o=this.tableWpId,l=this.prepareDataToSaveRemote(t),i=l.cells,n=l.rows,s=this;if(i.length>0){var r={action:"wdt_save_table_cells_frontend",table_id:o,cells:i,rows:n};e.ajax({url:a.adminAjaxBaseUrl,type:"POST",dataType:"json",data:r,success:function(e){s.toggleTableOverlay("hide"),(e.error.length>0||e.has_new)&&s.getRemoteTableData(),e.error.length>0?alert(e.error):e.formula_cells&&s.applyCellsData(e.formula_cells,"updateFormulaValues")},error:function(e){s.toggleTableOverlay("hide"),alert(e.error),s.getRemoteTableData()},beforeSend:function(){s.toggleTableOverlay("show")}})}},t.prototype.applyCellsData=function(e,t){if(0!=e.length){for(var a=[],o=this.hot,l=o.getSettings().idColumnKey,i=o.countRows(),n=0;i>n;n++)for(var s=o.getDataAtRowProp(n,l),r=0;r<e.length;r++){var h=e[r];if(h[l]==s)for(var d in h)d!=l&&a.push([n,d,h[d]])}a.length>0&&o.setDataAtRowProp(a,t)}},t.prototype.onAfterChange=function(e,t){"loadData"!==t&&"updateFormulaValues"!==t&&this.saveChangesRemote(e);var a=this.hot;a.getSettings().search&&(a.search.query(this.$SEARCH_FIELD.val()),a.render())},t.prototype.onInit=function(){this.initTableSettings(),this.initEvents(),this.initSearch(),this.getRemoteTableData()},t.prototype.onAfterValidate=function(t,a,o,l,i){var n=e(document.activeElement),s=void 0;n.is(":input")&&(s=n.closest("#"+this.hot.rootElement.id+" > div")),s&&(s.tooltip("instance")||(s.attr("title",""),s.tooltip({content:wpdatatables_frontend_strings.invalid_value,show:!1,position:{my:"left bottom",at:"left-10 top-5"}})),t?(s.removeClass("invalid_editor_value"),s.tooltip("destroy")):(s.addClass("invalid_editor_value"),s.tooltip("open")))},t.prototype.addNewTableRow=function(e,t){var a=t.end.col,o=this.countEmptyRows(!0),l=this.countRows();if(o>0){var i=l-1;this.selectCell(i,a,i,a)}else{var n=this.countEmptyRows(!1);if(n>0){for(var s=0;l>s;s++)if(this.isEmptyRow(s))return void this.selectCell(s,a,s,a)}else this.alter("insert_row")}},t.prototype.deleteTableRows=function(t,a){for(var o=a.start.row,l=a.end.row,i=this.getSettings(),n=i.idColumnKey,s=this.propToCol(n),r=this.getData(o,s,l,s),h=[],d=0;d<r.length;d++){var u=r[d][0];u&&h.push(r[d][0])}if(h.length>0){var c=this.getPlugin("wpDataTablesExcelPlugin"),p=c.tableWpId,g={};g[n]=h;var b={action:"wdt_delete_table_rows",table_id:p,rows:g};e.ajax({type:"POST",url:i.adminAjaxBaseUrl,data:b,dataType:"json",success:function(e){if(c.toggleTableOverlay("hide"),e.error.length>0)c.getRemoteTableData();else if(e.success.length>0)for(var t=o;l>=t;t++)this.alter("remove_row",t);else c.getRemoteTableData()},error:function(e){c.toggleTableOverlay("hide"),console.log(e),c.getRemoteTableData()},beforeSend:function(){c.toggleTableOverlay("show")}})}},t.prototype.addContextMenuItems=function(){this.contextMenu={items:{add_row:{name:"New row",callback:this.addNewTableRow},remove_row:{name:"Delete row(s)",callback:this.deleteTableRows,disabled:function(){var e=this.getSelected();return e[0]==e[2]&&this.isEmptyRow(e[0])}}}},this.tableSettings.contextMenu=this.contextMenu},t.prototype.removeContextMenuItems=function(){},Handsontable.plugins.registerPlugin("wpDataTablesExcelPlugin",t)}(jQuery);